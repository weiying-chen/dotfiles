#!/usr/bin/env sh
set -eu

if [ "$#" -eq 0 ]; then
  echo "usage: ytl-add <youtube-url | search terms>" >&2
  exit 1
fi

input="$*"
list_file="${YTLIST_FILE:-$HOME/.local/share/yt-audio-list.tsv}"

case "$input" in
  http://*|https://*) url="$input" ;;
  *)
    url="$(yt-dlp --print webpage_url --skip-download "ytsearch1:$input" 2>/dev/null | head -n 1)"
    ;;
esac

if [ -z "${url:-}" ]; then
  echo "No video found" >&2
  exit 1
fi

title="$(yt-dlp --print title --skip-download "$url" 2>/dev/null | head -n 1)"
[ -n "${title:-}" ] || title="(unknown title)"

mkdir -p "$(dirname "$list_file")"
printf '%s\t%s\n' "$url" "$title" >> "$list_file"
printf 'Added: %s\n' "$title"
